{% extends 'stocks/base.j2' %}
{% block title %}{{ basket.name }} - Details{% endblock %}

{% block header %}
    {{ super() }}
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
{% endblock %}

{% block css %}
<style>
    .container {
        max-width: 1200px;
        margin: 0 auto;
        background: var(--container-bg);
        border-radius: 15px;
        padding: 40px;
        box-shadow: 0 10px 40px var(--shadow-color);
        transition: background 0.3s ease, box-shadow 0.3s ease;
    }

    .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        flex-wrap: wrap;
        gap: 20px;
    }

    h1 {
        color: var(--text-primary);
        font-size: 2.2em;
        transition: color 0.3s ease;
    }

    .description {
        color: var(--text-secondary);
        margin-bottom: 30px;
        font-size: 1.05em;
        transition: color 0.3s ease;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 20px;
        margin-bottom: 40px;
    }

    .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 4px 15px var(--shadow-light);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .stat-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px var(--shadow-light);
    }

    .stat-label {
        font-size: 0.9em;
        opacity: 0.9;
        margin-bottom: 10px;
    }

    .stat-value {
        font-size: 1.8em;
        font-weight: bold;
    }

    .positive {
        color: #4ade80;
    }

    .negative {
        color: #f87171;
    }

    .btn {
        padding: 12px 25px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1em;
        font-weight: 600;
        text-decoration: none;
        display: inline-block;
        transition: all 0.3s ease;
    }

    .btn-primary {
        background: #667eea;
        color: white;
    }

    .btn-primary:hover {
        background: #5568d3;
        transform: translateY(-2px);
    }

    .btn-danger {
        background: #ef4444;
        color: white;
    }

    .btn-danger:hover {
        background: #dc2626;
    }

    .btn-small {
        padding: 6px 12px;
        font-size: 0.85em;
    }

    .btn-success {
        background: #10b981;
        color: white;
    }

    .btn-success:hover {
        background: #059669;
    }

    .btn-secondary {
        background: #6b7280;
        color: white;
    }

    .btn-secondary:hover {
        background: #4b5563;
    }

    .btn-info {
        background: #3b82f6;
        color: white;
    }

    .btn-info:hover {
        background: #2563eb;
    }

    /* Share Modal Styles */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        animation: fadeIn 0.3s ease;
    }

    .modal-overlay.active {
        display: flex;
    }

    .modal-content {
        background: var(--container-bg);
        padding: 30px;
        border-radius: 15px;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        animation: slideUp 0.3s ease;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .modal-header h3 {
        color: var(--text-primary);
        margin: 0;
    }

    .modal-close {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: var(--text-secondary);
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.3s ease;
    }

    .modal-close:hover {
        background: #ef4444;
        color: white;
    }

    .share-link-container {
        display: flex;
        gap: 10px;
        margin: 20px 0;
    }

    .share-link-input {
        flex: 1;
        padding: 12px;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        background: var(--card-bg);
        color: var(--text-primary);
        font-size: 14px;
    }

    .copy-btn {
        padding: 12px 20px;
        background: #10b981;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    .copy-btn:hover {
        background: #059669;
        transform: translateY(-2px);
    }

    .copy-btn.copied {
        background: #667eea;
    }

    .share-stats {
        margin-top: 15px;
        padding: 15px;
        background: var(--card-bg);
        border-radius: 8px;
        color: var(--text-secondary);
        font-size: 14px;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @keyframes slideUp {
        from {
            transform: translateY(20px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }


    .section-title {
        font-size: 1.6em;
        color: var(--text-primary);
        margin-bottom: 20px;
        border-bottom: 3px solid #667eea;
        padding-bottom: 10px;
        transition: color 0.3s ease;
    }

    .stocks-table {
        width: 100%;
        border-collapse: collapse;
        background: var(--container-bg);
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 2px 10px var(--shadow-lighter);
        transition: background 0.3s ease, box-shadow 0.3s ease;
    }

    .stocks-table th {
        background: #667eea;
        color: white;
        padding: 15px;
        text-align: left;
        font-weight: 600;
    }

    .stocks-table td {
        padding: 15px;
        border-bottom: 1px solid var(--border-color);
        color: var(--text-primary);
        transition: color 0.3s ease, border-color 0.3s ease;
    }

    .stocks-table tr:hover {
        background: var(--table-hover);
    }

    .stocks-table tr:last-child td {
        border-bottom: none;
    }

    .badge {
        display: inline-block;
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.85em;
        font-weight: 600;
    }

    .badge-equal {
        background: #dbeafe;
        color: #1e40af;
    }

    .actions {
        display: flex;
        gap: 15px;
        margin-top: 30px;
        flex-wrap: wrap;
    }

    .info-box {
        background: var(--card-bg);
        border-left: 4px solid #667eea;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 30px;
        transition: background 0.3s ease;
    }

    .info-box h3 {
        color: var(--text-primary);
        margin-bottom: 10px;
        transition: color 0.3s ease;
    }

    .info-box p {
        color: var(--text-secondary);
        line-height: 1.6;
        transition: color 0.3s ease;
    }

    /* Edit mode styles */
    .editable-cell {
        position: relative;
    }

    .edit-input {
        width: 80px;
        padding: 6px 10px;
        border: 2px solid #667eea;
        border-radius: 6px;
        font-size: 0.95em;
        text-align: center;
        background: var(--container-bg);
        color: var(--text-primary);
        transition: all 0.3s ease;
    }

    .edit-input:focus {
        outline: none;
        border-color: #5568d3;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .edit-actions {
        display: flex;
        gap: 5px;
        margin-top: 8px;
    }

    .display-value {
        cursor: pointer;
        padding: 4px 8px;
        border-radius: 4px;
        transition: all 0.2s;
    }

    .display-value:hover {
        background: var(--table-hover);
    }

    .edit-icon {
        margin-left: 5px;
        color: #667eea;
        font-size: 0.85em;
        opacity: 0;
        transition: opacity 0.2s;
    }

    .display-value:hover .edit-icon {
        opacity: 1;
    }

    .loading {
        opacity: 0.6;
        pointer-events: none;
    }

    .alert {
        padding: 12px 20px;
        border-radius: 8px;
        margin-bottom: 15px;
        font-weight: 500;
    }

    .alert-error {
        background: #fee2e2;
        color: #991b1b;
        border-left: 4px solid #ef4444;
    }

    .alert-success {
        background: #d1fae5;
        color: #065f46;
        border-left: 4px solid #10b981;
    }

    /* Dark mode chart styles */
    .chart-section {
        margin: 30px 0;
        padding: 25px;
        background: var(--container-bg);
        border-radius: 12px;
        box-shadow: 0 2px 8px var(--shadow-lighter);
        transition: all 0.3s ease;
    }

    .period-btn {
        padding: 6px 12px;
        border: 1px solid var(--border-color);
        background: var(--container-bg);
        color: var(--text-primary);
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.9em;
        transition: all 0.3s ease;
    }

    .period-btn.active {
        border: 1px solid #667eea;
        background: #667eea;
        color: white;
    }

    .period-btn:hover:not(.active) {
        background: var(--card-bg);
    }

    .note-box {
        margin-top: 30px;
        padding: 20px;
        background: var(--card-bg);
        border-radius: 10px;
        transition: background 0.3s ease;
    }

    .note-box p {
        color: var(--text-secondary);
        font-size: 0.95em;
        transition: color 0.3s ease;
    }

    /* Mobile Responsive for Basket Detail */
    @media (max-width: 768px) {
        .container {
            padding: 20px 15px;
        }

        h1 {
            font-size: 1.6em;
        }

        .header {
            flex-direction: column;
            align-items: stretch;
        }

        .section-title {
            font-size: 1.3em;
        }

        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .stat-card {
            padding: 15px;
        }

        .stat-label {
            font-size: 0.8em;
        }

        .stat-value {
            font-size: 1.4em;
        }

        .actions {
            flex-direction: column;
            width: 100%;
        }

        .btn {
            width: 100%;
            text-align: center;
        }

        /* Chart section mobile */
        .chart-section {
            padding: 15px;
        }

        .chart-section > div:first-child {
            flex-direction: column !important;
            align-items: stretch !important;
        }

        .period-selector {
            justify-content: flex-start !important;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 5px;
        }

        .period-btn {
            font-size: 0.8em;
            padding: 5px 10px;
        }

        .chart-section > div:nth-child(2) {
            height: 300px !important;
        }

        #performance-summary > div {
            grid-template-columns: 1fr !important;
        }

        /* Table responsive */
        .stocks-table {
            font-size: 0.85em;
        }

        .stocks-table th,
        .stocks-table td {
            padding: 10px 8px;
        }

        /* Hide less important columns on mobile */
        .stocks-table th:nth-child(6),
        .stocks-table td:nth-child(6) {
            display: none;
        }

        .edit-input {
            width: 60px;
            font-size: 0.85em;
        }

        .info-box {
            padding: 15px;
        }

        .note-box {
            padding: 15px;
        }
    }

    @media (max-width: 480px) {
        h1 {
            font-size: 1.4em;
        }

        .stats-grid {
            grid-template-columns: 1fr;
        }

        .stat-card {
            padding: 12px;
        }

        .stat-value {
            font-size: 1.2em;
        }

        .stocks-table {
            font-size: 0.75em;
        }

        .stocks-table th,
        .stocks-table td {
            padding: 8px 5px;
        }

        /* Show only essential table columns on very small screens */
        .stocks-table th:nth-child(4),
        .stocks-table td:nth-child(4),
        .stocks-table th:nth-child(5),
        .stocks-table td:nth-child(5) {
            display: none;
        }

        .chart-section > div:nth-child(2) {
            height: 250px !important;
        }

        .btn-small {
            padding: 4px 8px;
            font-size: 0.75em;
        }
    }

</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="header">
        <div>
            <h1>üìä {{ basket.name }}</h1>
            {% if basket.description %}
            <p class="description">{{ basket.description }}</p>
            {% endif %}
        </div>
        <div class="actions">
            <a href="{{ url('home') }}" class="btn btn-primary">‚Üê Back to Home</a>
            <a href="{{ url('basket_performance', args=[basket.id]) }}" class="btn btn-success">üìä Performance Analysis</a>
            <a href="{{ url('basket_duplicate', args=[basket.id]) }}" class="btn btn-secondary">üìã Duplicate Basket</a>
            <button id="share-basket-btn" class="btn btn-info" onclick="shareBasket({{ basket.id }})">üîó Share Basket</button>
            <a href="{{ url('basket_delete', args=[basket.id]) }}" class="btn btn-danger"
               onclick="return confirm('Are you sure you want to delete this basket?')">
                Delete Basket
            </a>
        </div>
    </div>


    <div id="message-container"></div>

    <div class="info-box">
        <h3>Equal Weight Strategy</h3>
        <p>
            This basket uses an equal-weight allocation strategy. You can now <strong>edit the weight or quantity</strong>
            of individual stocks by clicking on the values in the table below. When you change the weight, the quantity
            will automatically adjust, and vice versa.
        </p>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-label">Initial Investment</div>
            <div class="stat-value">‚Çπ{{ basket.investment_amount }}</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Current Value</div>
            <div class="stat-value" id="total-current-value">‚Çπ{{ total_current_value|round(2) }}</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Profit/Loss</div>
            <div class="stat-value {% if total_profit_loss >= 0 %}positive{% else %}negative{% endif %}" id="total-profit-loss">
                ‚Çπ{{ total_profit_loss }}
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Return %</div>
            <div class="stat-value {% if profit_loss_percentage >= 0 %}positive{% else %}negative{% endif %}" id="profit-loss-percentage">
                {{ profit_loss_percentage|round(2) }}%
            </div>
        </div>
    </div>

    <!-- AI Portfolio Insights Section (Powered by Puter.js) -->
    <div class="ai-analysis-section" style="margin: 30px 0; padding: 25px; background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%); border-radius: 12px; border: 2px solid #667eea30;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
            <h2 class="section-title" style="margin: 0; border: none; padding: 0;">ü§ñ Smart Portfolio Insights</h2>
            <button id="get-ai-insights" class="btn btn-primary" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);">
                ‚ú® Analyze My Portfolio
            </button>
        </div>
        <p style="color: var(--text-secondary); margin-bottom: 15px; font-size: 0.95em;">
            Get instant intelligent insights about your portfolio performance, diversification, and personalized recommendations.
        </p>
        <div id="ai-insights-result" style="
            min-height: 120px;
            padding: 20px;
            background: var(--container-bg);
            border-radius: 10px;
            white-space: pre-wrap;
            color: var(--text-primary);
            line-height: 1.8;
            box-shadow: inset 0 2px 8px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            justify-content: center;
            font-style: italic;
            color: var(--text-secondary);
        ">
            Click "Analyze My Portfolio" to get intelligent insights about your holdings, diversification, and actionable recommendations.
        </div>
    </div>

    <!-- Performance Comparison Chart -->
    <div class="chart-section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
            <h2 class="section-title" style="margin: 0;">üìà Performance Comparison</h2>
            <div class="period-selector" style="display: flex; gap: 8px; flex-wrap: wrap;">
                <button class="period-btn" data-period="1d">1D</button>
                <button class="period-btn" data-period="7d">7D</button>
                <button class="period-btn active" data-period="1m">1M</button>
                <button class="period-btn" data-period="3m">3M</button>
                <button class="period-btn" data-period="6m">6M</button>
                <button class="period-btn" data-period="1y">1Y</button>
                <button class="period-btn" data-period="3y">3Y</button>
                <button class="period-btn" data-period="5y">5Y</button>
            </div>
        </div>
        <div style="position: relative; height: 400px;">
            <canvas id="performanceChart"></canvas>
        </div>
        <div id="performance-summary" style="margin-top: 25px; padding-top: 20px; border-top: 1px solid var(--border-color);">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                <div style="padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px; color: white;">
                    <div style="font-size: 0.9em; opacity: 0.9; margin-bottom: 5px;">Your Basket: ‚Çπ100 invested ‚Üí</div>
                    <div style="font-size: 2em; font-weight: bold;" id="basket-final-value">‚Çπ100.00</div>
                    <div style="font-size: 0.85em; margin-top: 5px;" id="basket-return">Return: +0.00%</div>
                </div>
                <div style="padding: 15px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border-radius: 10px; color: white;">
                    <div style="font-size: 0.9em; opacity: 0.9; margin-bottom: 5px;">Nifty 50: ‚Çπ100 invested ‚Üí</div>
                    <div style="font-size: 2em; font-weight: bold;" id="nifty-final-value">‚Çπ100.00</div>
                    <div style="font-size: 0.85em; margin-top: 5px;" id="nifty-return">Return: +0.00%</div>
                </div>
            </div>
        </div>
        <div style="margin-top: 15px; text-align: center; color: var(--text-secondary); font-size: 0.9em;">
            Performance comparison: Value of ‚Çπ100 invested over selected time period
        </div>
    </div>

    <h2 class="section-title">Stock Holdings ({{ items|length }} stocks)</h2>

    <table class="stocks-table">
        <thead>
            <tr>
                <th>Stock</th>
                <th>Weight %</th>
                <th>Quantity</th>
                <th>Purchase Price</th>
                <th>Current Price</th>
                <th>Invested Amount</th>
                <th>Current Value</th>
                <th>P/L</th>
            </tr>
        </thead>
        <tbody>
            {% set total = namespace(qty=0, invested=0) %}
            {% for item in items %}
            {% set total.qty = total.qty + item.quantity %}
            {% set total.invested = total.invested + item.allocated_amount %}
            <tr data-item-id="{{ item.id }}">
                <td>
                    <strong>{{ item.stock.symbol }}</strong><br>
                    <small style="color: #666;">{{ item.stock.name }}</small>
                </td>
                <td class="editable-cell weight-cell">
                    <div class="display-mode">
                        <span class="display-value" onclick="enableEdit({{ item.id }}, 'weight')">
                            <span class="weight-value">{{ item.weight_percentage }}</span>%
                            <span class="edit-icon">‚úèÔ∏è</span>
                        </span>
                    </div>
                    <div class="edit-mode" style="display: none;">
                        <input type="number" step="0.01" class="edit-input weight-input" 
                               value="{{ item.weight_percentage }}" min="0.01" max="100">
                        <div class="edit-actions">
                            <button class="btn btn-success btn-small" onclick="saveEdit({{ item.id }}, 'weight')">‚úì</button>
                            <button class="btn btn-secondary btn-small" onclick="cancelEdit({{ item.id }}, 'weight')">‚úó</button>
                        </div>
                    </div>
                </td>
                <td class="editable-cell quantity-cell">
                    <div class="display-mode">
                        <span class="display-value" onclick="enableEdit({{ item.id }}, 'quantity')">
                            <span class="quantity-value">{{ item.quantity|int }}</span>
                            <span class="edit-icon">‚úèÔ∏è</span>
                        </span>
                    </div>
                    <div class="edit-mode" style="display: none;">
                        <input type="number" step="1" class="edit-input quantity-input" 
                               value="{{ item.quantity|int }}" min="1">
                        <div class="edit-actions">
                            <button class="btn btn-success btn-small" onclick="saveEdit({{ item.id }}, 'quantity')">‚úì</button>
                            <button class="btn btn-secondary btn-small" onclick="cancelEdit({{ item.id }}, 'quantity')">‚úó</button>
                        </div>
                    </div>
                </td>
                <td>‚Çπ{{ item.purchase_price }}</td>
                <td>
                    {% if item.stock.current_price %}
                        ‚Çπ{{ item.stock.current_price|round(2) }}
                    {% else %}
                        N/A
                    {% endif %}
                </td>
                <td class="allocated-amount">‚Çπ{{ item.allocated_amount }}</td>
                <td class="current-value">‚Çπ{{ item.get_current_value()|round(2) }}</td>
                <td class="profit-loss {% if item.get_profit_loss() >= 0 %}positive{% else %}negative{% endif %}">
                    ‚Çπ{{ item.get_profit_loss()|round(2) }}
                </td>
            </tr>
            {% endfor %}
            <tr style="font-weight: 700; background-color: rgba(102, 126, 234, 0.05); border-top: 2px solid var(--border-color);">
                <td>Total of all</td>
                <td>100%</td>
                <td>{{ total.qty|int }}</td>
                <td>-</td>
                <td>-</td>
                <td>‚Çπ{{ total.invested|round(2) }}</td>
                <td>‚Çπ{{ total_current_value|round(2) }}</td>
                <td class="{% if total_profit_loss >= 0 %}positive{% else %}negative{% endif %}">
                    ‚Çπ{{ total_profit_loss|round(2) }}
                </td>
            </tr>
        </tbody>
    </table>

    <div class="note-box">
        <p>
            <strong>Note:</strong> Stock prices are fetched from Yahoo Finance and may have a slight delay.
            Click on the weight or quantity values to edit them. When you change one, the other will automatically adjust.
            Created on: {{ basket.created_at }}
        </p>
    </div>
</div>

<!-- Share Modal -->
<div id="share-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3>üîó Share Your Basket</h3>
            <button class="modal-close" onclick="closeShareModal()">√ó</button>
        </div>
        <p style="color: var(--text-secondary); margin-bottom: 15px;">
            Share this short link with anyone to show them your basket:
        </p>
        <div class="share-link-container">
            <input type="text" id="share-link-input" class="share-link-input" readonly>
            <button class="copy-btn" onclick="copyShareLink()">
                <span id="copy-btn-text">Copy</span>
            </button>
        </div>
        <div id="share-stats" class="share-stats" style="display: none;">
            <strong>Link Stats:</strong><br>
            <span id="stats-content"></span>
        </div>
    </div>
</div>

{% endblock %}

{% block javascript %}
<script>
// Get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

const csrftoken = getCookie('csrftoken');

function showMessage(message, type) {
    const container = document.getElementById('message-container');
    const alert = document.createElement('div');
    alert.className = `alert alert-${type}`;
    alert.textContent = message;
    container.appendChild(alert);
    
    setTimeout(() => {
        alert.remove();
    }, 5000);
}

function enableEdit(itemId, field) {
    const row = document.querySelector(`tr[data-item-id="${itemId}"]`);
    const cell = row.querySelector(`.${field}-cell`);
    
    // Hide display, show edit
    cell.querySelector('.display-mode').style.display = 'none';
    cell.querySelector('.edit-mode').style.display = 'block';
    
    // Focus the input
    cell.querySelector('.edit-input').focus();
    cell.querySelector('.edit-input').select();
}

function cancelEdit(itemId, field) {
    const row = document.querySelector(`tr[data-item-id="${itemId}"]`);
    const cell = row.querySelector(`.${field}-cell`);
    
    // Show display, hide edit
    cell.querySelector('.display-mode').style.display = 'block';
    cell.querySelector('.edit-mode').style.display = 'none';
}

function saveEdit(itemId, field) {
    const row = document.querySelector(`tr[data-item-id="${itemId}"]`);
    const cell = row.querySelector(`.${field}-cell`);
    const input = cell.querySelector('.edit-input');
    const newValue = parseFloat(input.value);
    
    if (isNaN(newValue) || newValue <= 0) {
        showMessage('Please enter a valid positive number', 'error');
        return;
    }
    
    // Show loading state
    row.classList.add('loading');
    
    // Prepare form data
    const formData = new FormData();
    formData.append('update_type', field);
    if (field === 'weight') {
        formData.append('weight_percentage', newValue);
    } else {
        formData.append('quantity', newValue);
    }
    
    // Send AJAX request
    fetch(`/basket-item/${itemId}/edit/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrftoken,
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update all items in the table
            data.items.forEach(itemData => {
                const itemRow = document.querySelector(`tr[data-item-id="${itemData.id}"]`);
                if (itemRow) {
                    itemRow.querySelector('.weight-value').textContent = itemData.weight_percentage.toFixed(2);
                    itemRow.querySelector('.quantity-value').textContent = itemData.quantity;
                    itemRow.querySelector('.allocated-amount').textContent = '‚Çπ' + itemData.allocated_amount.toFixed(2);
                    itemRow.querySelector('.current-value').textContent = '‚Çπ' + itemData.current_value.toFixed(2);
                    
                    const plCell = itemRow.querySelector('.profit-loss');
                    plCell.textContent = '‚Çπ' + itemData.profit_loss.toFixed(2);
                    plCell.className = 'profit-loss ' + (itemData.profit_loss >= 0 ? 'positive' : 'negative');
                }
            });
            
            // Update investment amount if it changed
            if (data.investment_amount) {
                const investmentElement = document.querySelector('.stats-grid .stat-card:first-child .stat-value');
                if (investmentElement) {
                    investmentElement.textContent = '‚Çπ' + data.investment_amount.toFixed(2);
                }
            }
            
            // Update portfolio stats
            if (data.total_current_value !== undefined) {
                document.getElementById('total-current-value').textContent = '‚Çπ' + data.total_current_value.toFixed(2);
                
                const plElement = document.getElementById('total-profit-loss');
                plElement.textContent = '‚Çπ' + data.total_profit_loss.toFixed(2);
                plElement.className = 'stat-value ' + (data.total_profit_loss >= 0 ? 'positive' : 'negative');
                
                const plPercentElement = document.getElementById('profit-loss-percentage');
                plPercentElement.textContent = data.profit_loss_percentage.toFixed(2) + '%';
                plPercentElement.className = 'stat-value ' + (data.profit_loss_percentage >= 0 ? 'positive' : 'negative');
            }
            
            // Hide edit mode for the current item
            cancelEdit(itemId, field);
            
            // Update message based on edit type
            if (field === 'quantity') {
                showMessage('Quantity updated! Investment amount and all weights recalculated.', 'success');
            } else {
                showMessage('Updated successfully! Other stocks rebalanced to maintain 100% total.', 'success');
            }
        } else {
            showMessage(data.error || 'Failed to update', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMessage('An error occurred while updating', 'error');
    })
    .finally(() => {
        row.classList.remove('loading');
    });
}


// Allow Enter key to save, Escape to cancel
document.addEventListener('keydown', function(e) {
    const activeInput = document.activeElement;
    
    if (activeInput.classList.contains('edit-input')) {
        const cell = activeInput.closest('.editable-cell');
        const row = cell.closest('tr');
        const itemId = row.dataset.itemId;
        const field = cell.classList.contains('weight-cell') ? 'weight' : 'quantity';
        
        if (e.key === 'Enter') {
            e.preventDefault();
            saveEdit(itemId, field);
        } else if (e.key === 'Escape') {
            e.preventDefault();
            cancelEdit(itemId, field);
        }
    }
});

// Load and render performance comparison chart
let chartInstance = null;  // Store chart instance for updates

async function loadPerformanceChart(period = '1m') {
    try {
        const response = await fetch(`/basket/{{ basket.id }}/chart-data/?period=${period}`);
        const data = await response.json();
        
        if (data.success) {
            const ctx = document.getElementById('performanceChart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (chartInstance) {
                chartInstance.destroy();
            }
            
            // Create gradients for better visual effect
            const gradientBasket = ctx.createLinearGradient(0, 0, 0, 400);
            gradientBasket.addColorStop(0, 'rgba(102, 126, 234, 0.4)');
            gradientBasket.addColorStop(1, 'rgba(102, 126, 234, 0.01)');
            
            const gradientNifty = ctx.createLinearGradient(0, 0, 0, 400);
            gradientNifty.addColorStop(0, 'rgba(255, 99, 132, 0.4)');
            gradientNifty.addColorStop(1, 'rgba(255, 99, 132, 0.01)');
            
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [
                        {
                            label: data.datasets.basket.label,
                            data: data.datasets.basket.data,
                            borderColor: 'rgb(102, 126, 234)',
                            backgroundColor: gradientBasket,
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 0,
                            pointHoverRadius: 6,
                            pointHoverBackgroundColor: 'rgb(102, 126, 234)',
                            pointHoverBorderColor: '#fff',
                            pointHoverBorderWidth: 2
                        },
                        {
                            label: data.datasets.nifty.label,
                            data: data.datasets.nifty.data,
                            borderColor: 'rgb(255, 99, 132)',
                            backgroundColor: gradientNifty,
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 0,
                            pointHoverRadius: 6,
                            pointHoverBackgroundColor: 'rgb(255, 99, 132)',
                            pointHoverBorderColor: '#fff',
                            pointHoverBorderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            align: 'end',
                            labels: {
                                usePointStyle: true,
                                pointStyle: 'circle',
                                padding: 20,
                                font: {
                                    size: 13,
                                    family: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif"
                                }
                            }
                        },
                        tooltip: {
                            enabled: true,
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#fff',
                            titleFont: {
                                size: 14,
                                weight: 'bold'
                            },
                            bodyColor: '#fff',
                            bodyFont: {
                                size: 13
                            },
                            padding: 12,
                            displayColors: true,
                            borderColor: 'rgba(255, 255, 255, 0.1)',
                            borderWidth: 1,
                            callbacks: {
                                title: function(tooltipItems) {
                                    return 'Date: ' + tooltipItems[0].label;
                                },
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    const value = context.parsed.y;
                                    label += '‚Çπ' + value.toFixed(2);
                                    return label;
                                },
                                footer: function(tooltipItems) {
                                    // Show gain/loss from ‚Çπ100
                                    const basketValue = tooltipItems[0].parsed.y;
                                    const niftyValue = tooltipItems[1] ? tooltipItems[1].parsed.y : 100;
                                    const basketChange = basketValue - 100;
                                    const niftyChange = niftyValue - 100;
                                    
                                    return [
                                        '',
                                        tooltipItems[0].dataset.label + ' Return: ' + (basketChange >= 0 ? '+' : '') + basketChange.toFixed(2) + '%',
                                        tooltipItems[1] ? (tooltipItems[1].dataset.label + ' Return: ' + (niftyChange >= 0 ? '+' : '') + niftyChange.toFixed(2) + '%') : ''
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)',
                                drawBorder: false
                            },
                            ticks: {
                                callback: function(value) {
                                    return '‚Çπ' + value.toFixed(0);
                                },
                                font: {
                                    size: 12
                                },
                                color: '#666'
                            },
                            title: {
                                display: true,
                                text: 'Value of ‚Çπ100 Invested',
                                font: {
                                    size: 13,
                                    weight: 'bold'
                                },
                                color: '#333'
                            }
                        },
                        x: {
                            grid: {
                                display: false,
                                drawBorder: false
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 0,
                                autoSkip: true,
                                maxTicksLimit: 10,
                                font: {
                                    size: 11
                                },
                                color: '#666'
                            },
                            title: {
                                display: true,
                                text: 'Date',
                                font: {
                                    size: 13,
                                    weight: 'bold'
                                },
                                color: '#333'
                            }
                        }
                    },
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    hover: {
                        mode: 'index',
                        intersect: false
                    }
                }
            });
            
            // Update performance summary cards
            if (data.summary) {
                const basketFinal = data.summary.basket_final;
                const niftyFinal = data.summary.nifty_final;
                const basketReturn = data.summary.basket_return_pct;
                const niftyReturn = data.summary.nifty_return_pct;
                
                document.getElementById('basket-final-value').textContent = '‚Çπ' + basketFinal.toFixed(2);
                document.getElementById('nifty-final-value').textContent = '‚Çπ' + niftyFinal.toFixed(2);
                
                document.getElementById('basket-return').textContent = 'Return: ' + (basketReturn >= 0 ? '+' : '') + basketReturn.toFixed(2) + '%';
                document.getElementById('nifty-return').textContent = 'Return: ' + (niftyReturn >= 0 ? '+' : '') + niftyReturn.toFixed(2) + '%';
            }
        } else {
            document.querySelector('.chart-section').innerHTML = '<p style="text-align: center; color: #999;">Unable to load chart data: ' + (data.error || 'Unknown error') + '</p>';
        }
    } catch (error) {
        console.error('Error loading chart:', error);
        document.querySelector('.chart-section').innerHTML = '<p style="text-align: center; color: #999;">Unable to load chart data</p>';
    }
}


// Handle period button clicks
document.querySelectorAll('.period-btn').forEach(button => {
    button.addEventListener('click', function() {
        const period = this.getAttribute('data-period');
        
        // Update button states
        document.querySelectorAll('.period-btn').forEach(btn => {
            btn.style.background = 'white';
            btn.style.color = '#333';
            btn.style.borderColor = '#ddd';
            btn.classList.remove('active');
        });
        
        this.style.background = '#667eea';
        this.style.color = 'white';
        this.style.borderColor = '#667eea';
        this.classList.add('active');
        
        // Reload chart with new period
        loadPerformanceChart(period);
    });
});


// =============================================
// AI Portfolio Insights - Using Free AI API
// =============================================
document.getElementById('get-ai-insights').addEventListener('click', async function() {
    const btn = this;
    const resultBox = document.getElementById('ai-insights-result');
    
    // Show loading state
    btn.disabled = true;
    btn.innerHTML = 'üîÑ Analyzing with AI...';
    resultBox.style.fontStyle = 'normal';
    resultBox.style.justifyContent = 'flex-start';
    resultBox.style.alignItems = 'flex-start';
    resultBox.innerHTML = '<div style="width: 100%; text-align: center; padding: 30px; color: #667eea;"><div style="font-size: 24px; margin-bottom: 10px;">‚ö°</div><div>Analyzing your portfolio with AI...</div><div style="font-size: 0.9em; margin-top: 10px; color: var(--text-secondary);">This may take a few seconds</div></div>';
    
    try {
        // Gather portfolio data
        const portfolioData = {
            name: '{{ basket.name }}',
            investment: {{ basket.investment_amount }},
            currentValue: {{ total_current_value }},
            profitLoss: {{ total_profit_loss }},
            profitPercent: {{ profit_loss_percentage|round(2) }},
            stocks: [
                {% for item in items %}
                {
                    symbol: '{{ item.stock.symbol }}',
                    name: '{{ item.stock.name }}',
                    weight: {{ item.weight_percentage }},
                    quantity: {{ item.quantity|int }},
                    purchasePrice: {{ item.purchase_price }},
                    currentPrice: {{ item.stock.current_price or 0 }},
                    allocatedAmount: {{ item.allocated_amount }},
                    currentValue: {{ item.get_current_value() }},
                    profitLoss: {{ item.get_profit_loss() }}
                }{% if not loop.last %},{% endif %}
                {% endfor %}
            ]
        };
        
        // Build stock list for prompt
        const stockList = portfolioData.stocks
            .map(s => `- ${s.symbol} (${s.name}): ${s.weight.toFixed(2)}% weight, ${s.quantity} shares @ ‚Çπ${s.currentPrice.toFixed(2)}, P/L: ‚Çπ${s.profitLoss.toFixed(2)}`)
            .join('\n');
        
        // Calculate key metrics
        const topPerformer = portfolioData.stocks.reduce((max, stock) => 
            stock.profitLoss > max.profitLoss ? stock : max
        , portfolioData.stocks[0]);
        
        const worstPerformer = portfolioData.stocks.reduce((min, stock) => 
            stock.profitLoss < min.profitLoss ? stock : min
        , portfolioData.stocks[0]);
        
        // Generate analysis using rule-based system
        // This is a simple implementation - you can enhance it later with actual AI
        const analysis = generatePortfolioAnalysis(portfolioData, topPerformer, worstPerformer);
        
        // Simulate AI processing delay for UX
        await new Promise(resolve => setTimeout(resolve, 1500));
        
        // Display result with nice formatting
        resultBox.innerHTML = `
            <div style="width: 100%;">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 2px solid #667eea30;">
                    <span style="font-size: 24px;">ü§ñ</span>
                    <span style="font-weight: 600; color: #667eea;">Portfolio Analysis Complete</span>
                    <span style="margin-left: auto; font-size: 0.85em; color: var(--text-secondary);">AI-Powered Insights</span>
                </div>
                <div style="color: var(--text-primary); line-height: 1.8;">
                    ${analysis.split('\n\n').map(para => para.trim() ? `<p style="margin: 15px 0;">${para}</p>` : '').join('')}
                </div>
                <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border-color); font-size: 0.85em; color: var(--text-secondary); text-align: center;">
                    <span style="color: #10b981;">‚úì</span> Analysis generated using intelligent portfolio assessment
                </div>
            </div>
        `;
        
        btn.innerHTML = '‚úÖ Analysis Complete!';
        
        // Reset button after 3 seconds
        setTimeout(() => {
            btn.disabled = false;
            btn.innerHTML = '‚ú® Analyze My Portfolio';
        }, 3000);
        
    } catch (error) {
        console.error('AI Analysis Error:', error);
        
        resultBox.innerHTML = `
            <div style="width: 100%; padding: 20px; text-align: center;">
                <div style="font-size: 48px; margin-bottom: 15px;">‚ùå</div>
                <div style="font-weight: 600; color: #ef4444; margin-bottom: 10px;">Analysis Failed</div>
                <div style="color: var(--text-secondary); font-size: 0.95em;">${error.message}</div>
                <div style="margin-top: 15px; font-size: 0.85em; color: var(--text-secondary);">
                    Please try again or check your internet connection.
                </div>
            </div>
        `;
        
        btn.disabled = false;
        btn.innerHTML = '‚ú® Analyze My Portfolio';
    }
});

// Rule-based portfolio analysis generator
function generatePortfolioAnalysis(portfolio, topPerformer, worstPerformer) {
    const returnPercent = portfolio.profitPercent;
    const numStocks = portfolio.stocks.length;
    const isProfit = portfolio.profitLoss >= 0;
    
    // Performance Summary
    let perfSummary = '';
    if (returnPercent > 15) {
        perfSummary = `Your portfolio "${portfolio.name}" is performing exceptionally well with a return of ${returnPercent.toFixed(2)}% on your investment of ‚Çπ${portfolio.investment.toLocaleString()}. This significantly outperforms typical market benchmarks and indicates strong stock selection. Your current portfolio value stands at ‚Çπ${portfolio.currentValue.toLocaleString()}, representing a gain of ‚Çπ${portfolio.profitLoss.toLocaleString()}.`;
    } else if (returnPercent > 5) {
        perfSummary = `Your portfolio "${portfolio.name}" shows solid performance with a positive return of ${returnPercent.toFixed(2)}%. With an initial investment of ‚Çπ${portfolio.investment.toLocaleString()} now valued at ‚Çπ${portfolio.currentValue.toLocaleString()}, you've gained ‚Çπ${portfolio.profitLoss.toLocaleString()}. This healthy return demonstrates prudent investment choices and market timing.`;
    } else if (returnPercent > 0) {
        perfSummary = `Your portfolio "${portfolio.name}" is in positive territory with a ${returnPercent.toFixed(2)}% return, though growth has been modest. Starting from ‚Çπ${portfolio.investment.toLocaleString()}, you've reached a current value of ‚Çπ${portfolio.currentValue.toLocaleString()}, gaining ‚Çπ${portfolio.profitLoss.toLocaleString()}. There's room for improvement through strategic adjustments.`;
    } else if (returnPercent > -5) {
        perfSummary = `Your portfolio "${portfolio.name}" is experiencing a slight loss of ${Math.abs(returnPercent).toFixed(2)}%. Currently valued at ‚Çπ${portfolio.currentValue.toLocaleString()} against your initial ‚Çπ${portfolio.investment.toLocaleString()} investment, you're down ‚Çπ${Math.abs(portfolio.profitLoss).toLocaleString()}. This minor dip is not uncommon in volatile markets and may present opportunities for averaging down.`;
    } else {
        perfSummary = `Your portfolio "${portfolio.name}" is currently underperforming with a ${Math.abs(returnPercent).toFixed(2)}% loss. From your ‚Çπ${portfolio.investment.toLocaleString()} investment, the current value is ‚Çπ${portfolio.currentValue.toLocaleString()}, resulting in a loss of ‚Çπ${Math.abs(portfolio.profitLoss).toLocaleString()}. This requires careful review and potentially rebalancing your holdings.`;
    }
    
    // Diversification Analysis
    let divAnalysis = '';
    if (numStocks < 3) {
        divAnalysis = `Your portfolio has limited diversification with only ${numStocks} stock${numStocks === 1 ? '' : 's'}, which exposes you to significant company-specific risk. A concentrated portfolio can lead to high volatility, as your entire investment depends on the performance of very few companies. Consider expanding to at least 8-12 stocks across different sectors to spread risk effectively.`;
    } else if (numStocks < 6) {
        divAnalysis = `With ${numStocks} stocks, your portfolio shows moderate diversification. While this is better than being overly concentrated, there's still notable exposure to individual stock performance. To achieve optimal risk-adjusted returns, consider gradually increasing your holdings to 10-15 stocks across various sectors like technology, finance, pharma, and FMCG.`;
    } else if (numStocks < 10) {
        divAnalysis = `Your portfolio demonstrates good diversification with ${numStocks} different stocks, providing a reasonable spread of risk. This level of diversification helps cushion against poor performance in any single holding. To further optimize, ensure these stocks span multiple sectors and market caps to maximize the diversification benefit.`;
    } else {
        divAnalysis = `Excellent diversification! With ${numStocks} stocks, you've created a well-balanced portfolio that significantly reduces company-specific risk. This broad exposure helps smooth out volatility and provides participation in various market segments. Ensure you're not over-diversified to the point where tracking becomes difficult or returns become too diluted.`;
    }
    
    // Key Observations
    const topGainPercent = ((topPerformer.profitLoss / topPerformer.allocatedAmount) * 100).toFixed(2);
    const worstGainPercent = ((worstPerformer.profitLoss / worstPerformer.allocatedAmount) * 100).toFixed(2);
    
    const observations = `Your top performer is ${topPerformer.symbol} (${topPerformer.name}), delivering ${topGainPercent >= 0 ? 'a gain' : 'a loss'} of ${topGainPercent >= 0 ? '+' : ''}${topGainPercent}% or ‚Çπ${topPerformer.profitLoss.toFixed(2)}. This strong performance is pulling up your overall returns. Conversely, ${worstPerformer.symbol} (${worstPerformer.name}) is your weakest link with ${worstGainPercent >= 0 ? 'only' : ''} ${worstGainPercent}% return (‚Çπ${worstPerformer.profitLoss.toFixed(2)}). This divergence in stock performance highlights the importance of regular portfolio review and potential rebalancing.`;
    
    // Actionable Recommendation
    let recommendation = '';
    if (worstPerformer.profitLoss < -1000) {
        recommendation = `Consider reviewing ${worstPerformer.symbol}'s fundamentals and recent news. If the company's long-term prospects remain weak, it may be wise to reallocate this capital to stronger performers or new opportunities. Set a stop-loss threshold and evaluate whether this stock still aligns with your investment thesis. Don't let emotional attachment to losing positions erode your portfolio's potential.`;
    } else if (topPerformer.profitLoss > portfolio.investment * 0.3) {
        recommendation = `Your ${topPerformer.symbol} position has grown significantly. Consider booking partial profits to maintain your target asset allocation and reduce concentration risk. Rebalancing winners is a disciplined approach to lock in gains while maintaining portfolio balance. You could redirect these profits into undervalued opportunities or stocks with better growth potential.`;
    } else if (numStocks < 6) {
        recommendation = `Focus on gradually adding 3-4 more quality stocks across different sectors to improve diversification. Research companies in sectors not currently represented in your portfolio - perhaps banking, healthcare, or consumer goods. This will help reduce overall portfolio volatility and protect against sector-specific downturns while maintaining your growth potential.`;
    } else if (returnPercent < 0) {
        recommendation = `Review each holding's fundamentals and recent performance. For stocks with deteriorating business metrics, consider cutting losses and reallocating to stronger companies or averaging down on high-conviction positions that are temporarily undervalued. Don't try to catch a falling knife - only add to losers if the underlying business remains sound.`;
    } else {
        recommendation = `Your portfolio is well-positioned. Continue monitoring your holdings quarterly and maintain discipline in your investment approach. Consider setting up automatic rebalancing to maintain target allocations, and keep some cash ready to capitalize on market corrections. Stay invested in quality companies and avoid chasing short-term market trends.`;
    }
    
    return `${perfSummary}\n\n${divAnalysis}\n\n${observations}\n\n${recommendation}`;
}

// Load chart when page is ready
document.addEventListener('DOMContentLoaded', () => {
    loadPerformanceChart('1m');  // Default to 1 month
});

// Share Basket Functionality
async function shareBasket(basketId) {
    try {
        // Show loading state
        const shareBtn = document.getElementById('share-basket-btn');
        const originalText = shareBtn.innerHTML;
        shareBtn.innerHTML = '‚è≥ Generating...';
        shareBtn.disabled = true;
        
        // Call API to create tiny URL
        const response = await fetch(`/basket/${basketId}/share/`, {
            method: 'GET',
            headers: {
                'X-CSRFToken': csrftoken,
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Show modal with the short URL
            document.getElementById('share-link-input').value = data.short_url;
            document.getElementById('share-modal').classList.add('active');
            
            // Show stats if available
            if (data.click_count !== undefined) {
                const statsDiv = document.getElementById('share-stats');
                const statsContent = document.getElementById('stats-content');
                statsContent.innerHTML = `This link has been clicked ${data.click_count} time${data.click_count !== 1 ? 's' : ''}`;
                statsDiv.style.display = 'block';
            }
        } else {
            showMessage('Failed to create share link: ' + (data.error || 'Unknown error'), 'error');
        }
        
        // Reset button
        shareBtn.innerHTML = originalText;
        shareBtn.disabled = false;
        
    } catch (error) {
        console.error('Error creating share link:', error);
        showMessage('Failed to create share link', 'error');
        
        // Reset button
        const shareBtn = document.getElementById('share-basket-btn');
        shareBtn.innerHTML = 'üîó Share Basket';
        shareBtn.disabled = false;
    }
}

function closeShareModal() {
    document.getElementById('share-modal').classList.remove('active');
    // Reset copy button
    const copyBtn = document.getElementById('copy-btn-text');
    copyBtn.textContent = 'Copy';
    copyBtn.parentElement.classList.remove('copied');
}

async function copyShareLink() {
    const linkInput = document.getElementById('share-link-input');
    const copyBtnText = document.getElementById('copy-btn-text');
    const copyBtn = copyBtnText.parentElement;
    
    try {
        await navigator.clipboard.writeText(linkInput.value);
        copyBtnText.textContent = 'Copied!';
        copyBtn.classList.add('copied');
        
        // Reset after 2 seconds
        setTimeout(() => {
            copyBtnText.textContent = 'Copy';
            copyBtn.classList.remove('copied');
        }, 2000);
        
        showMessage('Link copied to clipboard!', 'success');
    } catch (error) {
        // Fallback for older browsers
        linkInput.select();
        document.execCommand('copy');
        copyBtnText.textContent = 'Copied!';
        copyBtn.classList.add('copied');
        
        setTimeout(() => {
            copyBtnText.textContent = 'Copy';
            copyBtn.classList.remove('copied');
        }, 2000);
        
        showMessage('Link copied to clipboard!', 'success');
    }
}

// Close modal when clicking outside
document.addEventListener('click', (e) => {
    const modal = document.getElementById('share-modal');
    if (e.target === modal) {
        closeShareModal();
    }
});
</script>
{% endblock %}

