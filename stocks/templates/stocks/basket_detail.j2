{% extends 'stocks/base.j2' %}
{% block title %}{{ basket.name }} - Details{% endblock %}

{% block header %}
    {{ super() }}
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
{% endblock %}

{% block css %}
<link rel="stylesheet" href="{{ static('css/pages/basket_detail.css') }}">
{% endblock %}

{% block content %}
<div class="container">
    <div class="header">
        <div>
            <h1>ğŸ“Š {{ basket.name }}</h1>
            {% if basket.description %}
            <p class="description">{{ basket.description }}</p>
            {% endif %}
        </div>
        <div class="actions">
            <a href="{{ url('home') }}" class="btn btn-primary">â† Back to Home</a>
            <a href="{{ url('basket_performance', args=[basket.id]) }}" class="btn btn-success">ğŸ“Š Performance Analysis</a>
            <a href="{{ url('basket_duplicate', args=[basket.id]) }}" class="btn btn-secondary">ğŸ“‹ Duplicate Basket</a>
            <button id="share-basket-btn" class="btn btn-info" onclick="shareBasket({{ basket.id }})">ğŸ”— Share Basket</button>
            <a href="{{ url('basket_delete', args=[basket.id]) }}" class="btn btn-danger"
               onclick="return confirm('Are you sure you want to delete this basket?')">
                Delete Basket
            </a>
        </div>
    </div>


    <div id="message-container"></div>

    <div class="info-box">
        <h3>Equal Weight Strategy</h3>
        <p>
            This basket uses an equal-weight allocation strategy. You can now <strong>edit the weight or quantity</strong>
            of individual stocks by clicking on the values in the table below. When you change the weight, the quantity
            will automatically adjust, and vice versa.
        </p>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-label">Initial Investment</div>
            <div class="stat-value">â‚¹{{ basket.investment_amount }}</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Current Value</div>
            <div class="stat-value" id="total-current-value">â‚¹{{ total_current_value|round(2) }}</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Profit/Loss</div>
            <div class="stat-value {% if total_profit_loss >= 0 %}positive{% else %}negative{% endif %}" id="total-profit-loss">
                â‚¹{{ total_profit_loss }}
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Return %</div>
            <div class="stat-value {% if profit_loss_percentage >= 0 %}positive{% else %}negative{% endif %}" id="profit-loss-percentage">
                {{ profit_loss_percentage|round(2) }}%
            </div>
        </div>
    </div>

    <!-- Performance Comparison Chart -->
    <div class="chart-section" data-basket-id="{{ basket.id }}">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
            <h2 class="section-title" style="margin: 0;">ğŸ“ˆ Performance Comparison</h2>
            <div class="period-selector" style="display: flex; gap: 8px; flex-wrap: wrap;">
                <button class="period-btn" data-period="1d">1D</button>
                <button class="period-btn" data-period="7d">7D</button>
                <button class="period-btn active" data-period="1m">1M</button>
                <button class="period-btn" data-period="3m">3M</button>
                <button class="period-btn" data-period="6m">6M</button>
                <button class="period-btn" data-period="1y">1Y</button>
                <button class="period-btn" data-period="3y">3Y</button>
                <button class="period-btn" data-period="5y">5Y</button>
            </div>
        </div>
        <div style="position: relative; height: 400px;">
            <canvas id="performanceChart"></canvas>
        </div>
        <div id="performance-summary" style="margin-top: 25px; padding-top: 20px; border-top: 1px solid var(--border-color);">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                <div style="padding: 16px; background: var(--primary-color); border-radius: var(--radius-md); color: white;">
                    <div style="font-size: 0.9em; opacity: 0.9; margin-bottom: 5px;">Your Basket: â‚¹100 invested â†’</div>
                    <div style="font-size: 2em; font-weight: bold; font-family: 'Inter', monospace; font-feature-settings: 'tnum';" id="basket-final-value">â‚¹100.00</div>
                    <div style="font-size: 0.85em; margin-top: 5px;" id="basket-return">Return: +0.00%</div>
                </div>
                <div style="padding: 16px; background: var(--container-bg); border: 1px solid var(--border-color); border-radius: var(--radius-md); color: var(--text-primary);">
                    <div style="font-size: 0.9em; color: var(--text-secondary); margin-bottom: 5px;">Nifty 50: â‚¹100 invested â†’</div>
                    <div style="font-size: 2em; font-weight: bold; font-family: 'Inter', monospace; font-feature-settings: 'tnum';" id="nifty-final-value">â‚¹100.00</div>
                    <div style="font-size: 0.85em; margin-top: 5px;" id="nifty-return">Return: +0.00%</div>
                </div>
            </div>
        </div>
        <div style="margin-top: 15px; text-align: center; color: var(--text-secondary); font-size: 0.9em;">
            Performance comparison: Value of â‚¹100 invested over selected time period
        </div>
    </div>

    <!-- Stock Holdings Table (rendered from partial template) -->
    <div id="stock_holdings_table">
        {% include 'stocks/_stock_holdings_table.j2' %}
    </div>
</div>

<!-- Share Modal -->
<div id="share-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Share Basket</h3>
            <button class="modal-close" onclick="closeShareModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <p class="share-description">
                Anyone with this link can view your basket's composition and performance.
            </p>
            
            <label class="share-label">Public Link</label>
            <div class="share-link-container">
                <div class="input-wrapper">
                    <span class="link-icon">ğŸ”—</span>
                    <input type="text" id="share-link-input" class="share-link-input" readonly>
                </div>
                <button class="copy-btn" onclick="copyShareLink()">
                    <span id="copy-btn-text">Copy</span>
                </button>
            </div>
            
            <div id="share-stats" class="share-stats" style="display: none;">
                <div class="stats-icon">ğŸ“Š</div>
                <div class="stats-info">
                    <strong>Link Performance</strong>
                    <span id="stats-content"></span>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block javascript %}
<script src="{{ static('js/pages/_stock_holdings_table.js') }}"></script>
<script src="{{ static('js/pages/basket-detail.js') }}"></script>
{% endblock %}
