<div class="stock-holdings-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <h2 class="section-title" style="margin-bottom: 0;">Stock Holdings ({{ items|length }} stocks)</h2>
    <button class="btn btn-primary" onclick="openAddStockModal()" id="add-stock-btn">
        ‚ûï Add Stock
    </button>
</div>

<table class="stocks-table">
    <thead>
        <tr>
            <th>Stock</th>
            <th>Weight %</th>
            <th>Quantity</th>
            <th>Purchase Price</th>
            <th>Current Price</th>
            <th>Invested Amount</th>
            <th>Current Value</th>
            <th>P/L</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% set total = namespace(qty=0, invested=0) %}
        {% for item in items %}
        {% set total.qty = total.qty + item.quantity %}
        {% set total.invested = total.invested + item.allocated_amount %}
        <tr data-item-id="{{ item.id }}">
            <td>
                <strong>{{ item.stock.symbol }}</strong><br>
                <small style="color: #666;">{{ item.stock.name }}</small>
            </td>
            <td class="editable-cell weight-cell">
                <div class="display-mode">
                    <span class="display-value" onclick="enableEdit({{ item.id }}, 'weight')">
                        <span class="weight-value">{{ item.weight_percentage }}</span>%
                        <span class="edit-icon">‚úèÔ∏è</span>
                    </span>
                </div>
                <div class="edit-mode" style="display: none;">
                    <input type="number" step="0.01" class="edit-input weight-input" 
                           value="{{ item.weight_percentage }}" min="0.01" max="100">
                    <div class="edit-actions">
                        <button class="btn btn-success btn-small" onclick="saveEdit({{ item.id }}, 'weight')">‚úì</button>
                        <button class="btn btn-secondary btn-small" onclick="cancelEdit({{ item.id }}, 'weight')">‚úó</button>
                    </div>
                </div>
            </td>
            <td class="editable-cell quantity-cell">
                <div class="display-mode">
                    <span class="display-value" onclick="enableEdit({{ item.id }}, 'quantity')">
                        <span class="quantity-value">{{ item.quantity|int }}</span>
                        <span class="edit-icon">‚úèÔ∏è</span>
                    </span>
                </div>
                <div class="edit-mode" style="display: none;">
                    <input type="number" step="1" class="edit-input quantity-input" 
                           value="{{ item.quantity|int }}" min="1">
                    <div class="edit-actions">
                        <button class="btn btn-success btn-small" onclick="saveEdit({{ item.id }}, 'quantity')">‚úì</button>
                        <button class="btn btn-secondary btn-small" onclick="cancelEdit({{ item.id }}, 'quantity')">‚úó</button>
                    </div>
                </div>
            </td>
            <td>‚Çπ{{ item.purchase_price }}</td>
            <td>
                {% if item.stock.current_price %}
                    ‚Çπ{{ item.stock.current_price|round(2) }}
                {% else %}
                    N/A
                {% endif %}
            </td>
            <td class="allocated-amount">‚Çπ{{ item.allocated_amount }}</td>
            <td class="current-value">‚Çπ{{ item.get_current_value()|round(2) }}</td>
            <td class="profit-loss {% if item.get_profit_loss() >= 0 %}positive{% else %}negative{% endif %}">
                ‚Çπ{{ item.get_profit_loss()|round(2) }}
            </td>
            <td>
                <button class="btn btn-danger btn-small" 
                        onclick="deleteStock({{ basket.id }}, {{ item.stock.id }}, {{ item.id }}, '{{ url('basket_stock_delete', args=[basket.id, item.stock.id ]) }}')"
                        title="Remove stock from basket"
                        id="basket-item-delete-stock-id-{{ item.id }}"
                        >
                    üóëÔ∏è  
                </button>       
            </td>
        </tr>
        {% endfor %}
        <tr style="font-weight: 600; background-color: var(--table-hover); border-top: 2px solid var(--border-color);">
            <td>Total of all</td>
            <td>100%</td>
            <td>{{ total.qty|int }}</td>
            <td>-</td>
            <td>-</td>
            <td>‚Çπ{{ total.invested|round(2) }}</td>
            <td>‚Çπ{{ total_current_value|round(2) }}</td>
            <td class="{% if total_profit_loss >= 0 %}positive{% else %}negative{% endif %}">
                ‚Çπ{{ total_profit_loss|round(2) }}
            </td>
            <td>-</td>
        </tr>
    </tbody>
</table>

<div class="note-box">
    <p>
        <strong>Note:</strong> Stock prices are fetched from Yahoo Finance and may have a slight delay.
        Click on the weight or quantity values to edit them. When you change one, the other will automatically adjust.
        Created on: {{ basket.created_at.strftime('%d %b %Y %H:%M') }}
    </p>
</div>

<!-- Add Stock Modal -->
<div id="add-stock-modal" class="modal-overlay" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); align-items: center; justify-content: center; z-index: 1000;">
    <div class="modal-content" style="background: var(--card-bg); border: 1px solid var(--border-color); box-shadow: var(--shadow-lg); border-radius: var(--radius-lg); width: 100%; max-width: 500px; max-height: 80vh; overflow: hidden; display: flex; flex-direction: column;">
        <div class="modal-header" style="padding: 20px 24px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; background: var(--bg-body);">
            <h3 style="margin: 0; font-size: 1.1em; font-weight: 600; color: var(--text-primary);">Add Stock to Basket</h3>
            <button class="modal-close" onclick="closeAddStockModal()" style="background: transparent; border: none; color: var(--text-secondary); font-size: 1.5rem; cursor: pointer; padding: 4px; line-height: 1; border-radius: 4px;">√ó</button>
        </div>
        <div class="modal-body" style="padding: 24px; overflow-y: auto;">
            <div style="margin-bottom: 16px;">
                <input type="text" id="stock-search-input" placeholder="Search stocks..." 
                    style="width: 100%; padding: 10px 12px; border: 1px solid var(--border-color); border-radius: var(--radius-md); background: var(--input-bg); color: var(--text-primary); font-size: 0.95rem;"
                    onkeyup="filterAvailableStocks()">
            </div>
            <div id="available-stocks-list" 
                style="max-height: 300px; overflow-y: auto;"
                hx-get="{{ url('basket_available_stocks', args=[basket.id]) }}"
                hx-trigger="load"
                hx-indicator="#stocks-loading">
                <div id="stocks-loading" style="text-align: center; padding: 20px; color: var(--text-secondary);">
                    Loading stocks...
                </div>
            </div>
        </div>
        <div class="modal-footer" style="padding: 16px 24px; border-top: 1px solid var(--border-color); background: var(--bg-body);">
            <button class="btn btn-secondary" onclick="closeAddStockModal()" style="padding: 10px 20px; border: 1px solid var(--border-color); border-radius: var(--radius-md); background: var(--container-bg); color: var(--text-primary); cursor: pointer;">Cancel</button>
        </div>
    </div>
</div>



