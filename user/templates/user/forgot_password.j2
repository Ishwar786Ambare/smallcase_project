{% extends 'stocks/base.j2' %}

{% block title %}Forgot Password - Reset Your Account{% endblock %}

{% block css %}
{{ super() }}
<style>
    .auth-container {
        max-width: 500px;
        margin: 80px auto;
        background: var(--container-bg);
        border-radius: 20px;
        padding: 40px;
        box-shadow: 0 10px 40px var(--shadow-color);
        border: 1px solid var(--card-border);
    }

    .auth-header {
        text-align: center;
        margin-bottom: 30px;
    }

    .auth-header h1 {
        color: var(--text-primary);
        font-size: 2em;
        margin-bottom: 10px;
    }

    .auth-header p {
        color: var(--text-secondary);
        font-size: 0.95em;
    }

    .step-container {
        display: none;
    }

    .step-container.active {
        display: block;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-group label {
        display: block;
        color: var(--text-primary);
        margin-bottom: 8px;
        font-weight: 500;
    }

    .form-group input {
        width: 100%;
        padding: 12px 15px;
        border: 2px solid var(--border-color);
        border-radius: 10px;
        font-size: 1em;
        background: var(--card-bg);
        color: var(--text-primary);
        transition: all 0.3s ease;
    }

    .form-group input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .method-selector {
        display: flex;
        gap: 15px;
        margin-bottom: 25px;
    }

    .method-btn {
        flex: 1;
        padding: 15px;
        border: 2px solid var(--border-color);
        border-radius: 10px;
        background: var(--card-bg);
        color: var(--text-primary);
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
        font-size: 1em;
    }

    .method-btn:hover {
        border-color: #667eea;
        background: rgba(102, 126, 234, 0.05);
    }

    .method-btn.active {
        border-color: #667eea;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .otp-input-group {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin: 30px 0;
    }

    .otp-input {
        width: 50px !important;
        height: 50px;
        text-align: center;
        font-size: 1.5em;
        font-weight: bold;
        border: 2px solid var(--border-color);
        border-radius: 10px;
    }

    .otp-input:focus {
        border-color: #667eea;
    }

    .btn-primary {
        width: 100%;
        padding: 14px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 1.1em;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 10px;
    }

    .btn-primary:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
    }

    .btn-primary:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .btn-secondary {
        width: 100%;
        padding: 12px;
        background: transparent;
        color: #667eea;
        border: 2px solid #667eea;
        border-radius: 10px;
        font-size: 1em;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 10px;
    }

    .btn-secondary:hover {
        background: #667eea;
        color: white;
    }

    .alert {
        padding: 12px 15px;
        border-radius: 8px;
        margin-bottom: 20px;
    }

    .alert-error {
        background: #fee2e2;
        color: #991b1b;
        border: 1px solid #fecaca;
    }

    .alert-success {
        background: #d1fae5;
        color: #065f46;
        border: 1px solid #a7f3d0;
    }

    .alert-info {
        background: #dbeafe;
        color: #1e40af;
        border: 1px solid #bfdbfe;
    }

    .timer-text {
        text-align: center;
        color: var(--text-secondary);
        font-size: 0.9em;
        margin-top: 15px;
    }

    .resend-link {
        color: #667eea;
        cursor: pointer;
        text-decoration: underline;
        font-weight: 500;
    }

    .resend-link:hover {
        color: #764ba2;
    }

    .auth-footer {
        margin-top: 25px;
        text-align: center;
        color: var(--text-secondary);
    }

    .auth-footer a {
        color: #667eea;
        text-decoration: none;
        font-weight: 500;
    }

    .auth-footer a:hover {
        color: #764ba2;
        text-decoration: underline;
    }

    .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255, 255, 255, .3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="auth-container">
    <div class="auth-header">
        <h1>üîê Forgot Password?</h1>
        <p>No worries! We'll send you an OTP to reset it.</p>
    </div>

    <!-- Alert Container -->
    <div id="alertContainer"></div>

    <!-- Step 1: Choose Method & Enter Identifier -->
    <div id="step1" class="step-container active">
        <div class="method-selector">
            <div class="method-btn active" data-method="email">
                üìß Email
            </div>
            <div class="method-btn" data-method="sms">
                üì± SMS
            </div>
        </div>

        <div class="form-group">
            <label for="identifier" id="identifierLabel">Email Address</label>
            <input type="text" id="identifier" placeholder="your.email@example.com" autocomplete="email">
        </div>

        <button type="button" class="btn-primary" id="sendOtpBtn">
            Send OTP
        </button>
    </div>

    <!-- Step 2: Verify OTP -->
    <div id="step2" class="step-container">
        <p style="text-align: center; margin-bottom: 20px; color: var(--text-secondary);">
            We've sent a 6-digit OTP to <strong id="displayIdentifier"></strong>
        </p>

        <div class="otp-input-group">
            <input type="text" class="otp-input" maxlength="1" data-index="0" autocomplete="off">
            <input type="text" class="otp-input" maxlength="1" data-index="1" autocomplete="off">
            <input type="text" class="otp-input" maxlength="1" data-index="2" autocomplete="off">
            <input type="text" class="otp-input" maxlength="1" data-index="3" autocomplete="off">
            <input type="text" class="otp-input" maxlength="1" data-index="4" autocomplete="off">
            <input type="text" class="otp-input" maxlength="1" data-index="5" autocomplete="off">
        </div>

        <button type="button" class="btn-primary" id="verifyOtpBtn">
            Verify OTP
        </button>

        <div class="timer-text" id="timerText">
            Didn't receive the code? <span class="resend-link" id="resendOtp">Resend OTP</span>
        </div>

        <button type="button" class="btn-secondary" id="backToStep1">
            Change Email/Phone
        </button>
    </div>

    <!-- Step 3: Reset Password -->
    <div id="step3" class="step-container">
        <div class="form-group">
            <label for="newPassword">New Password</label>
            <input type="password" id="newPassword" placeholder="Minimum 8 characters" autocomplete="new-password">
        </div>

        <div class="form-group">
            <label for="confirmPassword">Confirm Password</label>
            <input type="password" id="confirmPassword" placeholder="Re-enter your password"
                autocomplete="new-password">
        </div>

        <button type="button" class="btn-primary" id="resetPasswordBtn">
            Reset Password
        </button>
    </div>

    <div class="auth-footer">
        Remember your password? <a href="{{ url('user:login') }}">Login here</a>
    </div>
</div>

<script>
    // Helper function to get CSRF token from cookie or hidden input
    function getCsrfToken() {
        // First try to get from hidden input field (most reliable)
        const csrfInput = document.querySelector('[name="csrfmiddlewaretoken"]');
        if (csrfInput && csrfInput.value) {
            return csrfInput.value;
        }

        // Fallback to cookie
        const name = 'csrftoken';
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();

        return '';
    }

    // State management
    let currentStep = 1;
    let selectedMethod = 'email';
    let identifier = '';
    let resetToken = '';

    // DOM Elements
    const step1 = document.getElementById('step1');
    const step2 = document.getElementById('step2');
    const step3 = document.getElementById('step3');
    const methodBtns = document.querySelectorAll('.method-btn');
    const identifierInput = document.getElementById('identifier');
    const identifierLabel = document.getElementById('identifierLabel');
    const sendOtpBtn = document.getElementById('sendOtpBtn');
    const otpInputs = document.querySelectorAll('.otp-input');
    const verifyOtpBtn = document.getElementById('verifyOtpBtn');
    const backToStep1Btn = document.getElementById('backToStep1');
    const resendOtpBtn = document.getElementById('resendOtp');
    const newPasswordInput = document.getElementById('newPassword');
    const confirmPasswordInput = document.getElementById('confirmPassword');
    const resetPasswordBtn = document.getElementById('resetPasswordBtn');
    const displayIdentifier = document.getElementById('displayIdentifier');
    const alertContainer = document.getElementById('alertContainer');

    // Method selection
    methodBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            methodBtns.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            selectedMethod = btn.dataset.method;

            if (selectedMethod === 'email') {
                identifierLabel.textContent = 'Email Address';
                identifierInput.placeholder = 'your.email@example.com';
                identifierInput.type = 'email';
            } else {
                identifierLabel.textContent = 'Phone Number';
                identifierInput.placeholder = '+1234567890';
                identifierInput.type = 'tel';
            }
        });
    });

    // Show alert
    function showAlert(message, type = 'error') {
        alertContainer.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
        setTimeout(() => {
            alertContainer.innerHTML = '';
        }, 5000);
    }

    // Step 1: Send OTP
    sendOtpBtn.addEventListener('click', function () {
        identifier = identifierInput.value.trim();

        if (!identifier) {
            showAlert('Please enter your ' + (selectedMethod === 'email' ? 'email' : 'phone number'));
            return;
        }

        sendOtpBtn.disabled = true;
        sendOtpBtn.innerHTML = '<span class="loading"></span> Sending...';

        console.log(identifier, selectedMethod);

        $.ajax({
            url: '{{ url("user:request_password_reset_otp") }}',
            method: 'POST',
            headers: {
                'X-CSRFToken': getCsrfToken()
            },
        {# contentType: 'application/json', #}
        data: {
            identifier: identifier,
            method: selectedMethod
        },
            success: function (data) {
                if (data.success) {
                    console.log(data);
                    displayIdentifier.textContent = identifier;
                    goToStep(2);
                    showAlert(data.message, 'success');
                    focusFirstOtpInput();
                } else {
                    showAlert(data.message);
                }
            },
            error: function (xhr, status, error) {
                console.log(xhr.responseText);
                console.log(error);
                console.log(status)
                showAlert('An error occurred. Please try again.');
            },
            complete: function () {
                sendOtpBtn.disabled = false;
                sendOtpBtn.textContent = 'Send OTP';
            }
    });
});

    // OTP Input handling
    otpInputs.forEach((input, index) => {
        input.addEventListener('input', (e) => {
            if (e.target.value.length === 1) {
                if (index < otpInputs.length - 1) {
                    otpInputs[index + 1].focus();
                }
            }
        });

        input.addEventListener('keydown', (e) => {
            if (e.key === 'Backspace' && !e.target.value && index > 0) {
                otpInputs[index - 1].focus();
            }
        });

        // Allow paste
        input.addEventListener('paste', (e) => {
            e.preventDefault();
            const pastedData = e.clipboardData.getData('text').slice(0, 6);
            pastedData.split('').forEach((char, i) => {
                if (otpInputs[i]) {
                    otpInputs[i].value = char;
                }
            });
            if (pastedData.length === 6) {
                otpInputs[5].focus();
            }
        });
    });

    function focusFirstOtpInput() {
        setTimeout(() => otpInputs[0].focus(), 100);
    }

    function getOtpValue() {
        return Array.from(otpInputs).map(input => input.value).join('');
    }

    function clearOtpInputs() {
        otpInputs.forEach(input => input.value = '');
        focusFirstOtpInput();
    }

    // Step 2: Verify OTP
    verifyOtpBtn.addEventListener('click', () => {
        const otp = getOtpValue();

        if (otp.length !== 6) {
            showAlert('Please enter the complete 6-digit OTP');
            return;
        }

        verifyOtpBtn.disabled = true;
        verifyOtpBtn.innerHTML = '<span class="loading"></span> Verifying...';

        $.ajax({
            url: '{{ url("user:verify_password_reset_otp") }}',
            type: 'POST',
        {# contentType: 'application/json', #}
        headers: {
            'X-CSRFToken': getCsrfToken()
        },
            data: {
            identifier: identifier,
            otp: otp
        },
            success: function (data) {
                if (data.success) {
                    resetToken = data.reset_token;
                    goToStep(3);
                    showAlert('OTP verified successfully!', 'success');
                } else {
                    showAlert(data.message);
                    clearOtpInputs();
                }
            },
            error: function () {
                showAlert('An error occurred. Please try again.');
            },
            complete: function () {
                verifyOtpBtn.disabled = false;
                verifyOtpBtn.textContent = 'Verify OTP';
            }
    });
});

    // Resend OTP
    resendOtpBtn.addEventListener('click', () => {
        clearOtpInputs();
        sendOtpBtn.click();
    });

    // Back to step 1
    backToStep1Btn.addEventListener('click', () => {
        goToStep(1);
        clearOtpInputs();
    });

    // Step 3: Reset Password

    resetPasswordBtn.addEventListener('click', () => {
        const newPassword = newPasswordInput.value;
        const confirmPassword = confirmPasswordInput.value;

        if (!newPassword || !confirmPassword) {
            showAlert('Please fill in all fields');
            return;
        }

        if (newPassword !== confirmPassword) {
            showAlert('Passwords do not match');
            return;
        }

        if (newPassword.length < 8) {
            showAlert('Password must be at least 8 characters');
            return;
        }

        resetPasswordBtn.disabled = true;
        resetPasswordBtn.innerHTML = '<span class="loading"></span> Resetting...';
        console.log('Reset Token:', resetToken)
        console.log('New Password:', newPassword)
        console.log('Confirm Password:', confirmPassword)

        $.ajax({
            url: '{{ url("user:reset_password_with_token") }}',
            method: 'POST',
            headers: {
                'X-CSRFToken': getCsrfToken()
            },
        {# contentType: 'application/json', #}
        data: {
            reset_token: resetToken,
            new_password: newPassword,
            confirm_password: confirmPassword
        },
            success: function (data) {
                if (data.success) {
                    showAlert(data.message, 'success');
                    setTimeout(() => {
                        window.location.href = '{{ url("user:login") }}';
                    }, 2000);
                } else {
                    showAlert(data.message);
                }
            },
            error: function (xhr, status, error) {
                showAlert('An error occurred. Please try again.');
            },
            complete: function () {
                resetPasswordBtn.disabled = false;
                resetPasswordBtn.textContent = 'Reset Password';
            }
    });
});


    // Navigate between steps
    function goToStep(step) {
        document.querySelectorAll('.step-container').forEach(s => s.classList.remove('active'));

        if (step === 1) {
            step1.classList.add('active');
        } else if (step === 2) {
            step2.classList.add('active');
        } else if (step === 3) {
            step3.classList.add('active');
        }

        currentStep = step;
    }
</script>
{% endblock %}